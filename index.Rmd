---
title: "Bego"
author: "Thomas Huet"
# date: "11/12/2020"
header-includes:
  # - \usepackage{float}
  # - \floatplacement{figure}{H}  #make every figure with capti
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 10, fig.height = 10)
# opts_chunk$set(fig.width=12, fig.height=8)
library(kableExtra)
library(dplyr)
library(knitr)
library(magick)
library(leaflet)
library(RPostgreSQL)
library(rdrop2)
library(rgl)
library(plotly)
library(rpostgis)


GHimgs <- "https://github.com/zoometh/C14/tree/main/docs/imgs/"

df.corresp.sect <- data.frame(LabelSect=c("Me","Fo","Vr",
                                          "Sm","Vm",
                                          "Cs","Go","Vb"),
                              sectors=c("Les Merveilles","Fontanalba","Valaurette",                                                                      "Sainte-Marie","Valmasque",
                                        "Col du Sabion","Gordolasque","Vei del Bouc"),
                              stringsAsFactors = F)
df.corresp.thm <- data.frame(prem=c("A","C","F","H","N","P","R","T","X"),
                             thm=c("Axes/Tools","Horned fig.","Halberd","Anthropomorph",
                                   "Unfigurative","Dagger","Reticulated/Topographic","Yoke",
                                   "Special fig."),
                             colors=c("green","red","lightgreen","blue","grey",                                                                                  "darkgreen","yellow","orange","darkgrey"),
                             stringsAsFactors = F)
thm.not.selected <- c("A","N","X")
impr.rocks <- list(c("4.3.16D"), # HBZZ
                   c("7.1.8"), # CdT
                   c("11.0.1"), # Roche de l'Autel
                   c("12.5.1@a") # Gande déesse
                   )
# rocks - - - - - - - - - - - - - - - - - - - - - 
roches <- read.table("img/ROCHES.csv", sep = ";", header = T, stringsAsFactors = F)
# merge to get full names of sectors
roches <- merge(roches,df.corresp.sect,by="LabelSect",all.x = TRUE)
roches$lbl.r <- paste0(roches$zone,'.',roches$groupe,'.',roches$roche)
# figures  - - - - - - - - - - - - - - - - - - - - - 
figures <- read.table("img/FIGURES.csv", sep = ",", header = T, stringsAsFactors = F)
figures$zone <- as.factor(figures$zone)
figures$prem <- toupper(figures$prem)
figures$lbl.r <- paste0(figures$zone,'.',figures$groupe,'.',figures$roche)
figures <- figures[figures$prem != '',] # rm NA
figures <- figures[!(figures$prem %in% thm.not.selected),] # rm N
figures <- merge(figures,df.corresp.thm,by="prem",all.x = TRUE)
# unique(figures$prem)
# source("func/functions.R") # load/run ? function
# f.lflt.chef(getwd()) # create leaflet html map of the CdT

f.ico.aRoche <- function(Z,G,R){
  con <- conn.pg()
  # sqll <- "select zone,groupe,roche,nom,histoseule,geographie ,ST_X(ST_Transform(wkb_geometry, 4326)) as x ,ST_Y(ST_Transform(wkb_geometry, 4326)) as y from roches_gravees"
  # roches.all <- dbGetQuery(con,sqll)
  # aRoche <- roches.all[roches.all$zone == Z & roches.all$groupe == G & roches.all$roche == R,]
  # transcript
  aZ <- tab.latin[tab.latin$arabe == Z,"latin"]
  aG <- tab.latin[tab.latin$arabe == G,"latin"]
  aR <- as.character(R)
  aRocheName <- paste0("Z",aZ,"G",aG,"R",aR)
  aPath <- paste0("Bego/Images/Images Faces/Z",aZ,"/Z",aZ,"G",aG,"/Z",aZ,"G",aG,"R",aR,".gif")
  aImg <- drop_media(aPath)
  # stele.chef.lk <- drop_media("Bego/Images/Images Faces/ZVII/ZVIIGI/ZVIIGIR8.gif")
  Plan_lk <- paste0('<img src="',
                    # stele.chef.lk,
                    aImg$link,
                    '" style="width: 55vw; max-width: 200px;" >')
  dbDisconnect(con)
  return(list(aImg$link,Plan_lk))
}
```

The mount Bego region is almost known for its rock-[art](#ra) but it is also one of the earliest [occupation](#occup) of early Neolithic

# The rock-art {#ra}

The site is divided into 7 sectors. Main ones are [**Les Merveilles** sector](#Me) and [**Fontanalba** sector](#Fo) 

```{r df.Sectors}
sect.roches.count <- roches %>%
  group_by(sectors) %>%
  summarise(nb.rocks=n())
sect.roches.count <- merge(sect.roches.count, df.corresp.sect, by="sectors")
sect.roches.count$url <- paste0("#",sect.roches.count$LabelSect) # add url
sect.roches.count$sectors <- paste0("[",sect.roches.count$sectors,"](",sect.roches.count$url,")")

# order
sect.roches.count <- sect.roches.count[with(sect.roches.count, order(-nb.rocks)), ]
# total
total <- c("TOTAL", sum(sect.roches.count$nb.rocks))
sect.roches.count <- rbind(sect.roches.count, total)
sect.roches.count$LabelSect <- sect.roches.count$url <- NULL
kable(sect.roches.count,"html") %>%
  kable_styling(full_width = FALSE, position = "center", font_size=12)

```

The entire site is about 900 ha, with the large majority of engraved rocks in the France territory but also a sector in between France and Italy (**Col du Sabion** sector) and a rock in Italy (**Vei del Bouc** sector)  

```{r lf.Sectors}
htmltools::includeHTML(paste0(getwd(),"/img/Bego.html"))
```

There's about 20,000 figuratives pecked engravings

```{r lf.figures, fig.width=7, fig.height=5}
# TODO: color chart by c'colors' field
figures.prem.sum <- figures %>% count(thm, zone)
# figures.prem.sum <- figures.prem.sum[figures.prem.sum$prem != '',] # rm NA
# figures.prem.sum <- figures.prem.sum[!(figures.prem.sum$prem %in% thm.not.selected),] # rm N
# merge to get thm fullname and colors
figures.prem.sum$lbl <- paste0(figures.prem.sum$thm,'<br>n = ',as.character(figures.prem.sum$n))
fig.count <- figures.prem.sum %>%
  plot_ly(x = ~zone,
          y = ~n,
          type = 'bar', 
          text = ~lbl,
          hoverinfo = 'text',
          hovertext = ~lbl,
          name = ~thm,
          color = ~thm) %>%
  layout(yaxis = list(title = 'Count'), barmode = 'stack')
fig.count
```

The main common engravings are, from large, [horned figures](#eng.p.thm.horn.horn) engraved.

The Zone 13 ([**Valaurette** sector](#Vr)) shows a distinctive profile with almost only [topographic figure](#eng.p.thm.geom.tp)

### Spatial distribution

#### Altitudes

Engravings are displayed on rocks between ~1990 m to ~2700

```{r altis.rocks, echo=F, fig.width=7, fig.height=15}
# altis
# roches.altis <- subset(roches, select=c(sectors,lbl.r,Z))
# roches.altis <- roches.altis[!is.na(roches.altis$Z),]
# roches.altis <- roches.altis[roches.altis$Z != 0,]
# min(roches.altis$Z)
# plot_ly(data = roches.altis,
#         x = ~sectors,
#         y = ~Z,
#         color = ~sectors,
#         type = 'scatter',
#         alpha = .5,
#         mode = "markers"
# )
impr.rocks <- roches[roches$lbl.r %in% unlist(impr.rocks),]
impr.rocks.altis <- subset(impr.rocks, select=c(sectors,nom,lbl.r,Z))
impr.rocks.altis$lbl <- paste0("<i>",impr.rocks.altis$nom,"</i><br>",impr.rocks.altis$lbl.r)
# hyperlink
impr.rocks.altis$text <- paste0("<a href='",getwd(),"/#","ZIVGIIIR16D","'>A</a>")
impr.rocks.altis$text <- "<a href='https://google.com'>A</a>"

roches.altis <- subset(roches, select=c(sectors,lbl.r,Z))
roches.altis <- roches.altis[!is.na(roches.altis$Z),]
roches.altis <- roches.altis[roches.altis$Z != 0,]
# roches.altis <- sample_n(roches.altis,100)
# min(roches.altis$Z)
plot_ly(data = roches.altis,
        x = ~sectors,
        y = ~Z,
        color = ~sectors,
        type = 'scatter',
        alpha = .5,
        mode = "markers",
        text = ~lbl.r,
        hoverinfo = 'text',
        hovertext = ~lbl.r,
        name = ~sectors) %>% 
  add_trace(x=impr.rocks.altis$sectors,
            y=impr.rocks.altis$Z,
            type = 'scatter',
            mode = "markers",
            # color = "#000000",
            inherit = F,
            showlegend = F) %>%
  # impressive
  add_annotations(x=impr.rocks.altis$sectors, y=impr.rocks.altis$Z,
                  text=impr.rocks.altis$lbl,
                  showarrow=T,
                  arrowhead=.5) %>%
  # .. + hyperlink
  add_trace(
    mode = 'text',
    textfont = list(
      color = 'transparent'
    ),
    showlegend = F,
    inherit = T
  )
```

# Impressive rocks

Impressive rock engravings are often the [anthropomorphs](#eng.p.thm.anth) while their represent only a narrow part of all figurative engravings

## *Roche de l'Homme aux bras en zigzag* ([Zone IV](#ZIV), Groupe III, Roche 16D) {#ZIVGIIIR16D}

In the Arpette sector lies the *Roche de l'Homme aux bras en zigzag* 

```{r lf.HBZZ}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/ZIVGIIIR16D.html"))
```

The rocks main figure is an [anthropomorph](#eng.p.thm.anth) with arms in zigzag.

```{r ic.HBZZ}
# Define variable containing url
# knitr::include_url(f.ico.aRoche(4,3,"16D")[[1]])
# url <- f.ico.aRoche(4,3,"16D")[[1]]
# url <- f.ico.aRoche(4,3,"16D")[[1]]
# # url <- "http://www.online-image-editor.com//styles/2014/images/example_image.png"
#  ![Hadley Wickham](`r url`).
```


## *Stèle du Chef de Tribu* ([Zone VII](#ZVII), Groupe I, Roche 8){#ZVIIGIR8}

In the vallées de Merveilles lies the unique stelae of the site, the so-called *Stèle du Chef de Tribu*


```{r lf.CdT}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/ZVIIGIR8.html"))
```


## Sectors

### **Les Merveilles** sector {#Me}

This is really important..

#### Zones

##### Zone I {#ZI}

This is the lowest important concentration of engravings in the Merveilles sector

```{r lf.Z1}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/Z1.html"))
```

The zone is characterised by figures à franges

##### Zone IV {#ZIV}

```{r lf.Z4}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/Z4.html"))
```

The most known rocks are the HBZZ

##### Zone VII {#ZVII}

```{r lf.Z7}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/Z7.html"))
```

The most known rocks are the CdT and the Christ

##### Zone XII {#ZXII}


```{r lf.Z12}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/Z12.html"))
```

### **Fontanalba** sector {#Fo}

This is really important..

### **Valaurette** sector {#Vr}

This is really important..

### **Sainte-Marie** sector {#Sm}

### **Valmasque** sector {#Vm}

### **Col du Sabion** sector {#Cs}

### **Gordolasque** sector {#Go}

It is equivalent to the zone XXIII. It has a unique engraved rock discovered by J. Begin.

```{r lf.Z23}
# load the lf map from img/CdT.html
# knitr::include_url("https://yihui.shinyapps.io/miniUI/")
# knitr::include_app(paste0(getwd(),"/img/m.html"), height = '600px')
htmltools::includeHTML(paste0(getwd(),"/img/Z23.html"))
```

### **Vei del Bouc** sector {#Vb}

## Engravings

### Altitudes

```{r altis.engr, echo=F, fig.width=7, fig.height=15}
# altis
figures.altis <- subset(figures, select=c(lbl.r,figure,thm))
roches.altis <- subset(roches, select=c(sectors,lbl.r,Z))
figures.altis <- merge(figures.altis,roches.altis, by="lbl.r", all.x=TRUE)
figures.altis <- figures.altis[figures.altis$sectors == "Les Merveilles", ]
figures.altis <- figures.altis[!is.na(figures.altis$Z),]
figures.altis$thm <- factor(figures.altis$thm, levels = unique(figures.altis$thm))
# figures.altis <- sample_n(figures.altis,250)
plot_ly(data = figures.altis,
        x = ~thm,
        y = ~Z,
        color = ~thm,
        type = 'scatter',
        alpha = .5,
        mode = "markers"
)
```

# The engravings {#eng}

There is two main techniques with only a narrow regsitry shared

## Pecked engravings {#eng.p}

### Themes {#eng.p.thm}

#### Horned figures and yokes {#eng.p.thm.horn}

##### Horned figures {#eng.p.thm.horn.horn}

#### Anthropomorph {#eng.p.thm.anth}

##### Figures à franges {#eng.p.thm.anth.ff}

#### Geometric

##### Topographic figures {#eng.p.thm.geom.tp}

# The early occupations {#occup}

## Gias del Ciari {#occup.gias.ciari}


